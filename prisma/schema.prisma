// This block defines the database connection.
// Prisma reads this from your .env file.
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// This block tells Prisma to generate the client.
// This is the standard configuration.
generator client {
  provider = "prisma-client-js"
}

// --- Enum Definitions ---
// Defines a set of allowed values for the Role.
enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
  CASHIER
  LABORANT
  CLEANER
}

// Defines the status of a contact issue
enum IssueStatus {
  PENDING
  REPLIED
}

// Defines the status of an appointment
enum AppointmentStatus {
  APPROVED
  CANCELLED
  DONE
}

// Defines the status of a leave request
enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// Defines the status of a home health request
enum HomeHealthStatus {
  PENDING
  APPROVED
  REJECTED
}

// --- Model Definitions ---

// Base User model for login and common info
model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  password   String // We will store a hashed password
  role       UserRole @default(PATIENT)
  firstName  String
  tckn  String   @unique // TCKN
  lastName   String
  phoneNumber      String?  @unique @db.VarChar(10) // Format: 5XXXXXXXXX (without +90)
  dateOfBirth DateTime?
  profilePhoto     String?  // Optional profile photo URL

  // Password reset fields
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?

  // Email verification fields
  isEmailVerified   Boolean   @default(false)
  emailToken        String?   @unique
  emailTokenExpiry  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Relationships ---
  // A user can be ONE patient (1-to-1)
  patient Patient?
  // A user can be ONE doctor (1-to-1)
  doctor  Doctor?
  // A user can be ONE admin (1-to-1)
  admin   Admin?
  // A user can be ONE laborant (1-to-1)
  laborant Laborant?
  // A user can be ONE cleaner (1-to-1)
  cleaner Cleaner?

  // Lab requests created by this user (doctor/admin)
  createdLabRequests MedicalFileRequest[]

  // Home health requests created by this user
  homeHealthRequests HomeHealthRequest[]

  @@map("users") // Maps this model to the "users" table in Postgres
}

// Patient model, linked to a User
model Patient {
  id     Int  @id @default(autoincrement())
  userId Int  @unique // Foreign key
  user   User @relation(fields: [userId], references: [id])

  // Patient-specific fields
  address          String?
  emergencyContact String?
  bloodType        String?

  // medicalHistory String? // We can add more fields later

  // --- Relationships ---
  // A patient can have MANY appointments
  appointments Appointment[]
  // A patient can have MANY medical files
  medicalFiles MedicalFile[]

  // Lab requests created for this patient
  labRequests MedicalFileRequest[]

  @@map("patients")
}

// Doctor model, linked to a User
model Doctor {
  id     Int  @id @default(autoincrement())
  userId Int  @unique // Foreign key
  user   User @relation(fields: [userId], references: [id])

  // Doctor-specific fields
  specialization String

  // Doctor profile information ("Doktor Hakkında" section)
  biography                 String? @db.Text    // Özgeçmiş
  expertiseAreas            String? @db.Text    // Uzmanlık Alanları 
  educationAndAchievements  String? @db.Text    // Eğitim & Başarılar 
  workPrinciples            String? @db.Text    // Çalışma İlkeleri

  // Rating fields (automatically calculated from appointments)
  averageRating Float? // Average rating from completed appointments
  totalRatings  Int    @default(0) // Total number of ratings

  // --- Relationships ---
  // A doctor can have MANY appointments
  appointments Appointment[]
  // A doctor can have MANY leave requests
  leaveRequests LeaveRequest[]

  @@map("doctors")
}

// Admin model, linked to a User
model Admin {
  id     Int  @id @default(autoincrement())
  userId Int  @unique // Foreign key
  user   User @relation(fields: [userId], references: [id])

  // Admin-specific fields
  // permissionsLevel Int? // We can add more fields later

  @@map("admins")
}

// Appointment model
model Appointment {
  id        Int     @id @default(autoincrement())
  patientId Int
  patient   Patient @relation(fields: [patientId], references: [id])
  doctorId  Int
  doctor    Doctor  @relation(fields: [doctorId], references: [id])

  date      String  // Format: DD.MM.YYYY (e.g., "25.11.2025")
  time      String  // Format: HH:MM (e.g., "10:00")
  status    AppointmentStatus @default(APPROVED)
  reminderSent Boolean @default(false) // Flag for 24-hour email reminder

  // Rating fields
  rating    Int?      // Patient rating (1-5)
  ratedAt   DateTime? // Rating timestamp

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("appointments")
}

// Leave Request model for doctors
model LeaveRequest {
  id        Int     @id @default(autoincrement())
  doctorId  Int
  doctor    Doctor  @relation(fields: [doctorId], references: [id])

  startDate String  // Format: YYYY-MM-DD
  startTime String  // Format: HH:MM
  endDate   String  // Format: YYYY-MM-DD
  endTime   String  // Format: HH:MM
  reason    String

  status    LeaveRequestStatus @default(PENDING)

  requestedAt DateTime @default(now())
  resolvedAt  DateTime?

  @@map("leave_requests")
}

// Contact Issue model for visitor contact forms
model ContactIssue {
  id           Int         @id @default(autoincrement())
  name         String
  email        String
  phone        String      @db.VarChar(10) // Format: 5XXXXXXXXX (without +90)
  subject      String
  message      String
  status       IssueStatus @default(PENDING)
  replyMessage String?     // Admin's reply message
  repliedAt    DateTime?   // When the admin replied

  createdAt    DateTime    @default(now())

  @@map("contact_issues")
}

// Laborant model, linked to a User
model Laborant {
  id     Int  @id @default(autoincrement())
  userId Int  @unique // Foreign key
  user   User @relation(fields: [userId], references: [id])

  // --- Relationships ---
  // A laborant can upload MANY medical files
  medicalFiles MedicalFile[]
  // Lab requests assigned to this laborant
  assignedLabRequests MedicalFileRequest[]

  @@map("laborants")
}

// Cleaner model, linked to a User
model Cleaner {
  id     Int  @id @default(autoincrement())
  userId Int  @unique // Foreign key
  user   User @relation(fields: [userId], references: [id])

  // --- Relationships ---
  // A cleaner can have MANY cleaning records
  cleaningRecords CleaningRecord[]

  @@map("cleaners")
}

// Medical File model for patient test results
model MedicalFile {
  id          Int      @id @default(autoincrement())
  patientId   Int
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  // laborantId is nullable to preserve file records when a laborant account is deleted
  // Historical/orphaned files with null laborantId can still be accessed by patients/doctors/admins
  laborantId  Int?
  laborant    Laborant? @relation(fields: [laborantId], references: [id], onDelete: SetNull)
  
  fileName    String       // Original file name
  fileUrl     String       // Cloudinary URL or local path
  fileType    String       // MIME type (application/pdf, image/jpeg)
  fileSizeKB  Float        // File size in KB
  
  testName    String       // Test name (Hemogram, Kan Tahlili, etc.)
  testDate    DateTime     // Test date
  description String?      // Optional description

  // Optional back-reference to a lab request (non-defining side)
  requestId   Int? @unique
  request     MedicalFileRequest? @relation("RequestFileRelation")
  
  deletedAt   DateTime?    // Soft delete timestamp (tombstone)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("medical_files")
}

// Enum for lab request status
enum RequestStatus {
  PENDING
  ASSIGNED
  COMPLETED
  CANCELED
}

// MedicalFileRequest model representing a doctor's request for a lab result upload
model MedicalFileRequest {
  id                 Int           @id @default(autoincrement())
  patientId          Int
  patient            Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)

  createdByUserId    Int
  createdByUser      User          @relation(fields: [createdByUserId], references: [id])

  assigneeLaborantId Int?
  assigneeLaborant   Laborant?     @relation(fields: [assigneeLaborantId], references: [id], onDelete: SetNull)

  fileTitle          String
  notes              String?
  status             RequestStatus @default(PENDING)

  medicalFileId      Int? @unique
  medicalFile        MedicalFile?  @relation("RequestFileRelation", fields: [medicalFileId], references: [id], onDelete: SetNull)

  requestedAt        DateTime      @default(now())
  assignedAt         DateTime?
  completedAt        DateTime?
  canceledAt         DateTime?

  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@map("medical_file_requests")
}

// Cleaning Record model for cleaner personnel
model CleaningRecord {
  id        Int     @id @default(autoincrement())
  cleanerId Int
  cleaner   Cleaner @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  area      String       // Cleaning area (e.g., "Zemin Kat Koridor")
  time      String       // Time slot (e.g., "Sabah", "Öğle", "Akşam")
  photoUrl  String?      // URL to uploaded cleaning photo
  
  date      String       // Date in YYYY-MM-DD format
  
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("cleaning_records")
}

// Home Health Request model for at-home healthcare service requests
model HomeHealthRequest {
  id             Int               @id @default(autoincrement())
  userId         Int
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fullName       String
  tckn           String            @db.VarChar(11)
  phoneNumber    String            @db.VarChar(10) // Format: 5XXXXXXXXX (without +90)
  email          String?
  address        String
  serviceType    String
  serviceDetails String?
  preferredDate  DateTime
  preferredTime  String?
  notes          String?
  
  status         HomeHealthStatus  @default(PENDING)
  approvedBy     Int?
  approvedAt     DateTime?
  approvalNote   String?
  
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@map("home_health_requests")
}
